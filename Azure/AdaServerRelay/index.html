<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <!--Reference the SignalR library. -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@3.1.8/dist/browser/signalr.min.js"></script>

    <title>Ada</title>
</head>
<style type="text/css">
    p { margin: 0px; padding: 0px; }
</style>
<body>
    <h4>Enter a message</h4>
    <input type="text" id="text_input" size="100" />

    <h4>Message log</h4>
    <div id="message_log"></div>
</body>
<script type="text/javascript">

    var hub = "@HUB@";
    var user = "web";
    var signalr_connection = null;
    var signalr_hub = null;

    function sendMessage(e) {
        if (e.key == 'Enter') {
            var message = document.getElementById('text_input').value;
            if (signalr_connection != null) {
                console.log("Send to 'log' hub: " + message);
                try {
                    // our signalr service is running in "serverless" mode so this send
                    // method will not work.  Instead we have to route the message through
                    // our http function.
                    // var rc = await signalr_connection.invoke("log", user, message);
                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", "/api/" + hub + "/post");
                    var data = JSON.stringify({ user: user, message: message });
                    xhr.send(data);
                } catch (err) {
                    console.log("error sending:" + err);
                }
            }
        }
    }

    function disconnectSignalr() {
        if (signalr_connection) {
            signalr_connection.stop();
            signalr_connection = null;
        }
    }
    function connectSignalr(hubName, userName) {
        if (!hubName) {
            disconnectSignalr();
            return;
        }
        hubName = hubName.toLowerCase();
        if (signalr_hub != hubName) {
            // switching hubs
            disconnectSignalr();
        }
        if (!signalr_connection) {
            signalr_hub = hubName;

            const connection = new signalR.HubConnectionBuilder()
                .configureLogging(signalR.LogLevel.Debug)
                .withAutomaticReconnect()
                .withUrl('/api/' + hubName)
                .build();

            connection.onclose(onConnectionError);

            connection.start()
                .then(() => onConnected(connection))
                .catch(error => onConnectionError(error.message));

            signalr_connection = connection;
            // keep the connection alive, we can use the connection to
            // send broadcastMessages from this client if we want to!
            // connection.send('log', message);
        }
    }

    function onConnected(connection) {
        console.log("SignalR is connected");
        connection.off('log');
        connection.on('log', onBroadcastMessage);
    }

    function onConnectionError(error) {
        if (error && error.message) {
            console.error(error.message);
        }
        signalr_connection = null;
    }

    function onBroadcastMessage(message) {
        console.log(message);
        var div = document.getElementById('message_log');
        var p = document.createElement("p");
        p.className = "log";
        p.innerHTML = message;
        div.appendChild(p);
    }

    window.addEventListener('load', (event) => {
        var text = document.getElementById('text_input');
        text.addEventListener('keydown', sendMessage);
        connectSignalr(hub, user);
    })


</script>
</html>